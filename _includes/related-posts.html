<div class="relatedPosts">
{% unless page.categories contains 'journal' or page.categories == '' %}
<h4>You may also enjoy</h4>
{% assign sameTagCount = 0 %}
{% assign maxsameTagCount = 3 %}
{% for post in site.posts %}
  {% for category in post.categories %}

    {% if category contains 'booknotes' %}
      {% for tag in post.tags %}
        {% if post.url != page.url and page.tags contains tag and sameTagCount < maxsameTagCount %}
            <h5>&raquo; <a href="{{ post.url }}">{{ post.title }}</a></h5>
            {% assign sameTagCount = sameTagCount | plus: 1 %}
        {% endif %}
      {% endfor %}

    {% else %}

      {% if post.url != page.url %}
        {% if page.categories contains category and sameTagCount < maxsameTagCount %}
          {% assign sameTagCount = sameTagCount | plus: 1 %}
          <h5>&raquo; <a href="{{ post.url }}">{{ post.title }}</a></h5>
        {% endif %}
      {% endif %}

    {% endif %}

  {% endfor %}
{% endfor %}
{% endunless %}

  <h5 class="">You can read all essays in the <a class="blog-post" href="/archive">Archive</a></h5>


</div>
